name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  actions: write  # Required for artifact deletion and management
  packages: read

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install provision module dependencies
        if [ -f provision/requirements.txt ]; then 
          pip install -r provision/requirements.txt
        fi
    
    - name: Lint Python code
      run: |
        # Install linting tools if available
        if [ -f tools/pymattertool/src/mattertool.py ]; then
          python -m py_compile tools/pymattertool/src/mattertool.py
        fi
        if [ -f provision/modules/credentials.py ]; then
          python -m py_compile provision/modules/credentials.py
        fi
    
    - name: Run provision script tests
      run: |
        cd provision
        if [ -f test_provision.py ]; then
          python test_provision.py
        fi
    
    - name: Create build artifacts
      run: |
        mkdir -p build-output
        echo "Build completed at $(date)" > build-output/build-info.txt
        if [ -d tools/pymattertool ]; then
          cp -r tools/pymattertool build-output/
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts-${{ github.run_number }}
        path: build-output/
        retention-days: 7
    
    - name: Clean up old artifacts (demonstration of artifact deletion)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "This job demonstrates artifact deletion permissions"
        echo "The 'actions: write' permission allows this workflow to delete artifacts"
        echo "Artifact cleanup would typically be handled by a separate cleanup workflow"