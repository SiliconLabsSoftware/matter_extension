name: Common Builder

on:
    workflow_call:
        inputs:
            json-file-path:
                required: true
                type: string
            path-to-example-app:
                required: true
                type: string
            example-app:
                required: true
                type: string
            build-type:
                required: true
                type: string
            platform:
                required: true
                type: string

jobs:
    build:
        name: ${{ inputs.platform }}-build-job
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v5
              with:
                  submodules: "true" 
            - name: Install tools
              uses: ./.github/actions/install-tools
            - name: Build ${{ inputs.example-app }}
              uses: SiliconLabsSoftware/matter_build_action@v2.0.0
              continue-on-error: ${{ inputs.build-type == 'custom-sqa' }}
              with:
                  json-file-path: ${{ inputs.json-file-path }}
                  path-to-example-app: ${{ inputs.path-to-example-app }}
                  example-app: ${{ inputs.example-app }}
                  build-script: "./slc/build.sh"
                  output-directory: " "
                  build-type: ${{ inputs.build-type }}

            - name: Create asset files
              if: startsWith(github.ref_name, 'release_')
              run: |
                  find out -type f \( -name "*.s37" -o -name "*.rps" \) | while read file; do
                      echo '<?xml version="1.0" encoding="UTF-8"?>' > "${file}.asset"
                      echo '<asset/>' >> "${file}.asset"
                      echo "Created ${file}.asset"
                  done

            - name: Upload artifacts
              uses: actions/upload-artifact@v5
              with:
                  name: ${{ inputs.example-app }}-${{inputs.platform}}-${{ inputs.build-type }}
                  path: |
                      out/*/*/artifact/**
                      !out/*/*-copy-sources/artifact/**
                  if-no-files-found: warn
                  overwrite: true

            - name: Debug map file locations
              if: |
                (github.ref_name == 'main' || startsWith(github.ref_name, 'release_') || github.ref_name == 'feature/MATTER-4661') &&  
                (inputs.example-app == 'lighting-app' || inputs.example-app == 'lock-app' || inputs.example-app == 'zigbee-matter-light')
              run: |
                echo "Current directory: $(pwd)"
                echo "Looking for map files..."
                find . -name "*.map" -type f | head -20
                echo "Testing artifact patterns..."
                find . -path "./out/brd4187c/*/*/build/debug/*.map" 2>/dev/null || echo "No files match brd4187c pattern"
                find . -path "./out/brd4407a/*/*/build/debug/*.map" 2>/dev/null || echo "No files match brd4407a pattern"  
                find . -path "./out/brd4338a/*/*/build/debug/*.map" 2>/dev/null || echo "No files match brd4338a pattern"
                echo "Checking exclusions..."
                find . -path "./out/*/*/*-bootloader/build/debug/*.map" 2>/dev/null || echo "No bootloader files to exclude"

            - name: Upload map file artifacts for specific boards
              if: |
                (github.ref_name == 'main' || startsWith(github.ref_name, 'release_') || github.ref_name == 'feature/MATTER-4661') &&  
                (inputs.example-app == 'lighting-app' || inputs.example-app == 'lock-app' || inputs.example-app == 'zigbee-matter-light')
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ inputs.example-app }}-map-files-${{ inputs.build-type }}
                  path: |
                      out/brd4187c/*/*/build/debug/*.map
                      out/brd4407a/*/*/build/debug/*.map  
                      out/brd4338a/*/*/build/debug/*.map
                      !out/*/*/*-bootloader/build/debug/*.map
                      !out/*/*-copy-sources/*/build/debug/*.map
                  if-no-files-found: warn
                  overwrite: true
