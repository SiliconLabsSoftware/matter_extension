name: PR validity

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check_testing_header:
    runs-on: ubuntu-latest
    steps:
      - name: Check for "**Testing Done:**" section in PR
        id: check-testing
        continue-on-error: true
        run: |
          cat >/tmp/pr-summary.txt << "EndMarkerForPrSummary"
          ${{ github.event.pull_request.body }}
          EndMarkerForPrSummary

          python -c 'import sys; pr_summary = open("/tmp/pr-summary.txt", "rt").read(); sys.exit(0 if "**Testing Done:**" in pr_summary else 1)'

      - name: Check for "**Description of Problem/Feature:**" section in PR
        id: check-description
        continue-on-error: true
        run: |
          cat >/tmp/pr-summary.txt << "EndMarkerForPrSummary"
          ${{ github.event.pull_request.body }}
          EndMarkerForPrSummary

          python -c 'import sys; pr_summary = open("/tmp/pr-summary.txt", "rt").read(); sys.exit(0 if "**Description of Problem/Feature:**" in pr_summary else 1)'

      - name: Fail if "**Testing Done:**" section not in PR
        if: (steps.check-testing.outcome == 'failure') && (github.event.pull_request.user.login != 'dependabot[bot]')

        run: |
          python -c 'import sys; print("Testing section missing (test failed)"); sys.exit(1)'
