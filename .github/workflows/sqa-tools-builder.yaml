name: Build SQA Tools

on:
  workflow_call:
    inputs:
      build-type:
        required: true
        type: string

concurrency:
    group: sqa-tools-builder-${{ github.ref }}
    cancel-in-progress: true

env:
  PW_ENVIRONMENT_ROOT: ${{ github.workspace }}/.environment

jobs:
  package-scripts:
    runs-on: [silabs-internal, austin]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        submodules: false
    
    - name: Install zip utility
      shell: bash
      run: |
        if ! command -v zip &> /dev/null; then
          echo "Installing zip utility..."
          if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y zip
          elif command -v yum &> /dev/null; then
            sudo yum install -y zip
          elif command -v brew &> /dev/null; then
            brew install zip
          else
            echo "Package manager not found. Please install zip manually."
            exit 1
          fi
        else
          echo "zip utility is already installed"
        fi
    
    #zip Provision folder
    - name: Zip provisioning tool
      shell: bash
      run: |
        set -euo pipefail
        LC_ALL=C
        
        # Constants / paths
        SRC_DIR=provision
        OUT_DIR=sqa-tools
        ARCHIVE=provision.zip

        # On error, show a small subset of the source tree for debugging
        trap 'echo "[ERROR] Provision zip step failed; sample tree:"; find "${SRC_DIR}" -maxdepth 3 -type f 2>/dev/null | head -100' ERR

        # Validate source directory exists early
        [[ -d "${SRC_DIR}" ]] || { echo "Missing ${SRC_DIR} directory" >&2; exit 1; }

        echo "Creating ${ARCHIVE} (excluding hardware-specific and cache paths)..."
        # -r recursive, -9 max compression, -X omit extra file attributes for reproducibility, -q quiet
        zip -r -9 -X -q "${ARCHIVE}" "${SRC_DIR}" \
          -x "${SRC_DIR}/support/efr32*" \
          -x "${SRC_DIR}/support/si917*" \
          -x "${SRC_DIR}/modules/__pycache__/*"

        # Sanity check: ensure archive has more than just the header lines (very small archives will have only a couple of lines in listing)
        if ! unzip -l "${ARCHIVE}" 2>/dev/null | awk 'END {exit (NR<=3)}'; then
          echo "Archive ${ARCHIVE} appears empty; failing." >&2
            exit 1
        fi

        # Output directory + move
        mkdir -p "${OUT_DIR}"
        mv "${ARCHIVE}" "${OUT_DIR}/"

        echo "Archive size: $(du -h ${OUT_DIR}/${ARCHIVE} | cut -f1)"
        echo "Provisioning tool zipped successfully: ${OUT_DIR}/${ARCHIVE}"

    - name: Mark repository as safe for Git
      shell: bash
      run: |
        git config --global --add safe.directory $(pwd)

    - name: Initialize required submodules
      shell: bash
      run: |
        git submodule update --init third_party/matter_sdk
    
    - name: Zip OTA scripts
      shell: bash
      run: |
          ota_file="ota-scripts.zip"
          cd third_party/matter_sdk/
          zip -r "${ota_file}" "scripts/tools/silabs" "src/app/ota_image_tool.py" "src/controller/python/chip/tlv" -x "*.md" "provision/samples/light/3"
          mv "${ota_file}" ../../sqa-tools/
          echo "OTA scripts zipped successfully: sqa-tools/${ota_file}"

  build-sqa-tools:
    runs-on: [silabs-internal, austin]
    container:
      image: ghcr.io/project-chip/chip-build-crosscompile:81

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false
      
      - name: Mark repository as safe for Git
        shell: bash
        run: |
          git config --global --add safe.directory $(pwd)

      - name: Initialize required submodules
        shell: bash
        run: |
          git submodule update --init third_party/matter_sdk

      - name: Checkout matter_sdk submodules
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/checkout_submodules.py --platform linux

      - name: Run bootstrap action
        uses: SiliconLabsSoftware/matter_build_action/bootstrap@v1.2.0

      # Builds chip-tool
      - name: Build chip-tool
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py --target linux-arm64-chip-tool-ipv6only-clang build"
      
      # Builds OTA provider
      - name: Build OTA provider
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py --target linux-arm64-ota-provider-ipv6only-clang build"

      # Builds all-clusters app
      - name: Build all-clusters app
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py --target linux-arm64-all-clusters-clang build"

      # Copy Artifacts at on location
      - name: Copy Build Artifacts to output directory
        shell: bash
        run: |
          mkdir -p sqa-tools/
          cp third_party/matter_sdk/out/linux-arm64-chip-tool-ipv6only-clang/chip-tool sqa-tools/
          cp third_party/matter_sdk/out/linux-arm64-ota-provider-ipv6only-clang/chip-ota-provider-app sqa-tools/
          cp third_party/matter_sdk/out/linux-arm64-all-clusters-clang/chip-all-clusters-app sqa-tools/
    
    # copy wifi firmware
  copy-wifi-firmware:
    runs-on: [silabs-internal, austin]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false

      - name: Setup SLT
        id: setup-action
        uses: SiliconLabsInternal/action-setup-slt@main

      - name: Check SLT version
        run: |
          echo "SLT version installed: ${{ steps.setup-action.outputs.slt-version }}"
          echo "SLT executable path : ${{ steps.setup-action.outputs.slt-path }}"
          echo "conan_engine version installed: ${{ steps.setup-action.outputs.conan-engine-version }}"
          echo "conan_engine executable path: ${{ steps.setup-action.outputs.conan-engine-path }}"
          echo "conan version installed: ${{ steps.setup-action.outputs.conan-version }}"
          echo "conan executable path: ${{ steps.setup-action.outputs.conan-path }}"
          
      - name: install wiseconnect firmware packages
        continue-on-error: true
        run: |
          conan remote add wiseconnect-conan-sqa https://artifactory.silabs.net/artifactory/api/conan/wiseconnect-conan-sqa
          slt install -f packages/wifi_firmware.slt
      
      - name: locate wifi packages
        run: |
          echo "WISECONNECT3_DIR=$(slt where nwp_firmware_siwx91x)" >> $GITHUB_ENV

      - name: Create WiFi firmware directories
        shell: bash
        run: |
          mkdir -p sqa-tools/WiFi-Firmware/siwx917 sqa-tools/WiFi-Firmware/rs911x/{Evk_1.4,Evk_1.5}

      - name: Copy WiFi firmware files
        shell: bash
        run: |
          cp ${WISECONNECT3_DIR}/connectivity_firmware/standard/SiWG917-B.*.rps sqa-tools/WiFi-Firmware/siwx917/
          echo "WiFi firmware files copied successfully."