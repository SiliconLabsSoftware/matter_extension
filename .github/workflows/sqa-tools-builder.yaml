name: Build SQA Tools

on:
  workflow_call:
    inputs:
      build-type:
        required: true
        type: string

concurrency:
  group: sqa-tools-builder-${{ github.ref }}
  cancel-in-progress: true

env:
  PW_ENVIRONMENT_ROOT: ${{ github.workspace }}/.environment

jobs:
  package-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false

      - name: Mark repository as safe for Git
        shell: bash
        run: |
          git config --global --add safe.directory /__w/matter_extension/matter_extension

      - name: Initialize required submodules
        shell: bash
        run: |
          git submodule update --init third_party/matter_sdk \
            third_party/matter_support

      # Zip Provision folder
      - name: Zip provisioning tool
        shell: bash
        run: |
          set -euo pipefail
          LC_ALL=C
          SRC_DIR=third_party/matter_support/provision
          OUT_DIR=sqa-tools
          ARCHIVE=provision.zip
          SRC_BASENAME=$(basename "${SRC_DIR}")
          SRC_PARENT=$(dirname "${SRC_DIR}")

          trap 'echo "[ERROR] Provision zip step failed; sample tree:"; find "${SRC_DIR}" -maxdepth 3 -type f 2>/dev/null | head -100' ERR
          [[ -d "${SRC_DIR}" ]] || { echo "Missing ${SRC_DIR} directory" >&2; exit 1; }

          echo "Creating ${ARCHIVE} with root directory ${SRC_BASENAME}/ ..."
          (
            cd "${SRC_PARENT}"
            zip -r -9 -X -q "${OLDPWD}/${ARCHIVE}" "${SRC_BASENAME}" \
              -x "${SRC_BASENAME}/support/efr32*" \
              -x "${SRC_BASENAME}/support/si917*" \
              -x "${SRC_BASENAME}/modules/__pycache__/*" \
              -x "${SRC_BASENAME}/headers/*" \
              -x "${SRC_BASENAME}/libs/*" \
              -x "${SRC_BASENAME}/args.gni" \
              -x "${SRC_BASENAME}/BUILD.gn"
          )

          if ! unzip -l "${ARCHIVE}" 2>/dev/null | awk 'END {exit (NR<=3)}'; then
            echo "Archive ${ARCHIVE} appears empty; failing." >&2
            exit 1
          fi

          mkdir -p "${OUT_DIR}"
          mv "${ARCHIVE}" "${OUT_DIR}/"
          echo "Archive size: $(du -h ${OUT_DIR}/${ARCHIVE} | cut -f1)"
          echo "Provisioning tool zipped successfully: ${OUT_DIR}/${ARCHIVE}"

      - name: Zip OTA scripts
        shell: bash
        run: |
          set -euo pipefail
          ota_file="ota-scripts.zip"
          cd third_party/matter_sdk/
          
          # Validate that all required files and directories exist
          required_paths=(
            "scripts/tools/silabs"
            "src/app/ota_image_tool.py"
            "src/controller/python/matter/tlv/"
          )
          
          for path in "${required_paths[@]}"; do
            if [[ ! -e "${path}" ]]; then
              echo "[ERROR] Required path does not exist: ${path}" >&2
              exit 1
            fi
          done
          
          zip -r "${ota_file}" "scripts/tools/silabs" "src/app/ota_image_tool.py" "src/controller/python/matter/tlv/" -x "*.md" "provision/samples/light/3"
          
          if ! unzip -l "${ota_file}" 2>/dev/null | awk 'END {exit (NR<=3)}'; then
            echo "[ERROR] Archive ${ota_file} appears empty; failing." >&2
            exit 1
          fi
          
          mv "${ota_file}" ../../sqa-tools/
          echo "Archive size: $(du -h ../../sqa-tools/${ota_file} | cut -f1)"
          echo "OTA scripts zipped successfully: sqa-tools/${ota_file}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: sqa-tools-zip
          path: sqa-tools
          if-no-files-found: error
          overwrite: true

  build-sqa-tools:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/project-chip/chip-build-crosscompile:81

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false

      - name: Mark repository as safe for Git
        shell: bash
        run: |
          git config --global --add safe.directory /__w/matter_extension/matter_extension

      - name: Initialize required submodules
        shell: bash
        run: |
          git submodule update --init third_party/matter_sdk

      - name: Checkout matter_sdk submodules
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/checkout_submodules.py --platform linux

      - name: Run bootstrap action
        uses: SiliconLabsSoftware/matter_build_action/bootstrap@v2.0.0

      # Builds chip-tool
      - name: Build chip-tool
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py --target linux-arm64-chip-tool-ipv6only-clang build"

      # Builds OTA provider
      - name: Build OTA provider
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py --target linux-arm64-ota-provider-ipv6only-clang build"

      # Builds all-clusters app
      - name: Build all-clusters app
        shell: bash
        run: |
          cd third_party/matter_sdk
          ./scripts/run_in_build_env.sh "./scripts/build/build_examples.py --target linux-arm64-all-clusters-clang build"

      # Copy Artifacts at on location
      - name: Copy Build Artifacts to output directory
        shell: bash
        run: |
          mkdir -p sqa-tools/
          cp third_party/matter_sdk/out/linux-arm64-chip-tool-ipv6only-clang/chip-tool sqa-tools/
          cp third_party/matter_sdk/out/linux-arm64-ota-provider-ipv6only-clang/chip-ota-provider-app sqa-tools/
          cp third_party/matter_sdk/out/linux-arm64-all-clusters-clang/chip-all-clusters-app sqa-tools/

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: sqa-tools-binaries
          path: sqa-tools
          if-no-files-found: error
          overwrite: true

    # copy wifi firmware
  copy-wifi-firmware:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false

      - name: Mark repository as safe for Git
        shell: bash
        run: |
          git config --global --add safe.directory /__w/matter_extension/matter_extension
      
      - name: Initialize required submodules
        shell: bash
        run: |
          git submodule update --init third_party/wifi_sdk

      - name: Create WiFi firmware directories
        shell: bash
        run: |
          mkdir -p sqa-tools/WiFi-Firmware/siwx917

      - name: Copy WiFi firmware files
        shell: bash
        run: |
          cp third_party/wifi_sdk/connectivity_firmware/standard/SiWG917-B.*.rps sqa-tools/WiFi-Firmware/siwx917/
          echo "WiFi firmware files copied successfully."

      - name: Upload WiFi firmware artifacts
        uses: actions/upload-artifact@v5
        with:
          name: sqa-tools-wifi-firmware
          path: sqa-tools
          if-no-files-found: error
          overwrite: true

  merge-artifacts:
    runs-on: ubuntu-latest
    needs:
      - build-sqa-tools
      - package-scripts
      - copy-wifi-firmware
    if: success()

    steps:
      - name: Merge sqa-tools Artifacts
        uses: actions/upload-artifact/merge@v5
        with:
          name: sqa-tools-${{ inputs.build-type }}
          delete-merged: true
          pattern: sqa-tools-*
